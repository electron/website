name: Audit Docs Version

on:
  workflow_dispatch:
  schedule:
    - cron: '0 17 * * *'

permissions: {}

jobs:
  audit_docs_version:
    name: Audit Docs Version
    if: github.repository == 'electron/website'
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '22.13.0'
      - run: npm install @electron/fiddle-core@2.0.0
      - name: Confirm latest version
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { setTimeout } = await import('node:timers/promises');
            const { ElectronVersions } = await import('${{ github.workspace }}/node_modules/@electron/fiddle-core/dist/index.js');

            const DOCS_SHA_REGEX = /<meta name="?docs-sha"? content="?(\w+)"?>/m;
            const DELTA_THRESHOLD_MS = 1000*60*20;

            const resp = await fetch('https://electronjs.org');

            if (!resp.ok) {
              core.setFailed('Could not fetch website');
              return;
            }

            const latestDocsSHA = (await resp.text()).match(DOCS_SHA_REGEX)?.[1];

            const versions = await ElectronVersions.create({ ignoreCache: true });

            const { data: { published_at: publishedAt } } = await github.rest.repos.getReleaseByTag({
              owner: 'electron',
              repo: 'electron',
              tag: `v${versions.latestStable.version}`,
            });

            const { data: commit } = await github.rest.repos.getCommit({
              owner: 'electron',
              repo: 'electron',
              ref: `refs/tags/v${versions.latestStable.version}`,
            });

            const delta = Date.now() - new Date(publishedAt).getTime();

            // If the release was published recently, wait a bit for the site
            // to deploy before checking so we don't get a false positive
            if (delta < DELTA_THRESHOLD_MS) {
              await setTimeout(DELTA_THRESHOLD_MS - delta);
            }

            if (commit.sha !== latestDocsSHA) {
              // Allow commits to be newer in case we want to deploy a docs hotfix
              const comparison = await github.rest.repos.compareCommitsWithBasehead({
                owner: 'electron',
                repo: 'electron',
                basehead: `${commit.sha}...${latestDocsSHA}`,
              });

              if (comparison.status !== 200) {
                throw new Error('Failed to compare commits');
              }

              if (comparison.data.behind_by === 0 && comparison.data.ahead_by >= 0) {
                core.summary.addRaw('ðŸŽ‰ Docs are up-to-date');
              } else {
                console.log(`Got ${latestDocsSHA}, expected ${commit.sha}`);
                core.summary.addRaw('ðŸš¨ Docs are NOT up-to-date');

                // Set this as failed so it's easy to scan runs to find failures
                process.exitCode = 1;
              }
            } else {
              core.summary.addRaw('ðŸŽ‰ Docs are up-to-date');
            }

            await core.summary.write();
